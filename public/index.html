<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>ë²ˆí˜¸í‘œ í˜¸ì¶œ ëª¨ë‹ˆí„°</title>
  <style>
    html, body {margin:0;padding:0;overflow:hidden;background:black;height:100%;width:100%;}
    video {position:fixed;top:0;left:0;width:100%;height:100%;object-fit:cover;z-index:0;}
    #popup {position:fixed;top:0;left:0;width:100%;height:100%;
      background:rgba(0,0,0,0.5);display:none;justify-content:center;align-items:center;
      z-index:1;color:white;text-align:center;}
    #popup h1 {font-size:400px;animation:blink 2s infinite;margin:0;}
    @keyframes blink {0%,50%,100%{opacity:1;}25%,75%{opacity:0.2;}}
  </style>
</head>
<body>

  <video id="bgVideo" autoplay muted loop playsinline>
    <source src="bg.mp4" type="video/mp4" />
  </video>

  <div id="popup"><h1 id="numText"></h1></div>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    const popup = document.getElementById("popup");
    const numText = document.getElementById("numText");
    const bgVideo = document.getElementById("bgVideo");
    const socket = io();

    // -------------------------------------------
    //  ðŸ”¥ ì˜¤ë””ì˜¤ ìžë™ìž¬ìƒ ì •ì±… ê°•ì œ ìš°íšŒ (ì‚¼ì„±ì¸í„°ë„· ì „ìš© ì™„ì „ë²„ì „)
    // -------------------------------------------
    let audioUnlocked = false;

    function unlockAudio() {
      if (audioUnlocked) return;

      // ë¬´ìŒ mp3ì„ ì‹¤ì œë¡œ ìž¬ìƒí•´ì•¼ ê¶Œí•œì´ í•´ì œë¨
      const silent = new Audio("sounds/silent.mp3");  // âš ï¸ silent.mp3 íŒŒì¼ í•˜ë‚˜ í•„ìš”í•¨ (0.1ì´ˆ ë¬´ìŒ)
      silent.volume = 0;
      silent.play()
        .then(() => {
          audioUnlocked = true;
          console.log("ðŸ”ˆ ì˜¤ë””ì˜¤ ìžë™ìž¬ìƒ ê¶Œí•œ í•´ì œë¨");

          // ë°±ê·¸ë¼ìš´ë“œ ì˜ìƒë„ í•œë²ˆ ê°•ì œ ì‹¤í–‰
          bgVideo.muted = true;
          bgVideo.play().catch(() => {});
        })
        .catch(() => {});
    }

    // ì²« í„°ì¹˜ì—ì„œë§Œ ì‹¤í–‰
    document.body.addEventListener("click", unlockAudio, { once:true });

    // ì‚¼ì„±ì¸í„°ë„·ì—ì„œ ì˜ìƒ ë©ˆì¶¤ ë²„ê·¸ ë°©ì§€
    setInterval(() => {
      if (bgVideo.paused) {
        bgVideo.play().catch(()=>{});
      }
    }, 1500);
    // -------------------------------------------


    // -------------------------------------------
    //  ðŸ”” í˜¸ì¶œ ì†Œë¦¬ ìž¬ìƒ í•¨ìˆ˜ (ê¶Œí•œ í•´ì œ í›„ì—ëŠ” 100% ìž¬ìƒë¨)
    // -------------------------------------------
    function playSound(number) {
      if (!audioUnlocked) unlockAudio(); // í˜¹ì‹œë¼ë„ ì‹¤í–‰ ì•ˆëìœ¼ë©´ ê°•ì œë°œë™

      const audio = new Audio(`sounds/${number}.mp3`);
      audio.play().catch(() => {
        console.warn("ðŸ”‡ ì˜¤ë””ì˜¤ ìž¬ìƒ ì‹¤íŒ¨ (ê¶Œí•œ ë¯¸í•´ì œ)");
      });
    }
    // -------------------------------------------


    // íŒì—… í•¨ìˆ˜
    function showPopup(number) {
      numText.textContent = number;
      popup.style.display = "flex";
      playSound(number);
      setTimeout(() => popup.style.display = "none", 7000);
    }

    // URL ì±„ë„ ì½”ë“œ
    const params = new URLSearchParams(window.location.search);
    const channel = (params.get("ch") || "A000").toUpperCase();
    socket.emit("joinRoom", channel);

    socket.on("call", data => showPopup(data.number));
    socket.on("recall", data => showPopup(data.number));
    socket.on("reset", () => popup.style.display = "none");
  </script>
</body>
</html>
