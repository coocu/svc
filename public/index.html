<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>ë²ˆí˜¸í‘œ í˜¸ì¶œ ëª¨ë‹ˆí„°</title>
  <style>
    html, body {margin:0;padding:0;overflow:hidden;background:black;height:100%;width:100%;}
    video {position:fixed;top:0;left:0;width:100%;height:100%;object-fit:cover;z-index:0;}
    #popup {
      position:fixed;top:0;left:0;width:100%;height:100%;
      background:rgba(0,0,0,0.5);
      display:none;justify-content:center;align-items:center;
      z-index:1;color:white;text-align:center;
    }
    #popup h1 {font-size:400px;animation:blink 2s infinite;margin:0;}
    @keyframes blink {0%,50%,100%{opacity:1;}25%,75%{opacity:0.2;}}
  </style>
</head>
<body>
  <!-- ë°°ê²½ ì˜ìƒ -->
  <video id="bgVideo" autoplay muted loop playsinline>
    <source src="bg.mp4" type="video/mp4" />
  </video>

  <!-- íŒì—… -->
  <div id="popup"><h1 id="numText"></h1></div>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    const popup = document.getElementById("popup");
    const numText = document.getElementById("numText");
    const socket = io();

    // ===============================
    //  ì±„ë„ ì½”ë“œ ì½ê¸° (?ch=z399)
    // ===============================
    const params = new URLSearchParams(window.location.search);
    const channel = (params.get("ch") || "A000").toUpperCase();
    socket.emit("joinRoom", channel);

    // ===============================
    //  ì˜¤ë””ì˜¤ ë¬¸ì œ í•´ê²°: ì „ì—­ ìœ ì§€
    // ===============================
    let currentAudio = null;

    function playSound(number) {
      try {
        // ì´ì „ ì¬ìƒ ì¤‘ì¸ ì˜¤ë””ì˜¤ ì •ì§€
        if (currentAudio) {
          currentAudio.pause();
          currentAudio.currentTime = 0;
        }

        // ìƒˆë¡œìš´ ì˜¤ë””ì˜¤ ê°ì²´ (ì „ì—­)
        currentAudio = new Audio(`sounds/${number}.mp3`);

        // ëê¹Œì§€ ì¬ìƒ ê°•ì œ
        currentAudio.onended = () => {
          console.log(`ğŸ”Š ${number}.mp3 ì¬ìƒ ì™„ë£Œ`);
        };

        currentAudio.play().catch(err => {
          console.warn("ì˜¤ë””ì˜¤ ì¬ìƒ ì‹¤íŒ¨:", err);
        });

      } catch (e) {
        console.warn("playSound ì˜¤ë¥˜:", e);
      }
    }

    // ===============================
    //  íŒì—… í‘œì‹œ
    // ===============================
    function showPopup(number) {
      numText.textContent = number;
      popup.style.display = "flex";

      playSound(number);

      setTimeout(() => {
        popup.style.display = "none";
      }, 7000);  // íŒì—…ë§Œ ë‹«ê³  ì†Œë¦¬ëŠ” ëê¹Œì§€ ì¬ìƒ
    }

    // ===============================
    //  ì†Œì¼“ ì´ë²¤íŠ¸
    // ===============================
    socket.on("call", data => showPopup(data.number));
    socket.on("recall", data => showPopup(data.number));
    socket.on("reset", () => popup.style.display = "none");

    // ===============================
    //  ëª¨ë°”ì¼ ë¸Œë¼ìš°ì € ì˜¤ë””ì˜¤ ê¶Œí•œ í™•ë³´
    // ===============================
    document.body.addEventListener("click", () => {
      try {
        if (!currentAudio) {
          currentAudio = new Audio("sounds/silent.mp3");  // ë¬´ìŒ íŒŒì¼ í•„ìˆ˜
        }
        currentAudio.play().catch(()=>{});
        console.log("ğŸ”ˆ ì˜¤ë””ì˜¤ ìë™ì¬ìƒ ê¶Œí•œ í™•ë³´ë¨");
      } catch (e) {}
    }, { once: true });
  </script>
</body>
</html>
